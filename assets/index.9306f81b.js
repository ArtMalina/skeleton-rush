var E=Object.defineProperty;var L=Object.getOwnPropertySymbols;var x=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable;var w=(e,t,i)=>t in e?E(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,g=(e,t)=>{for(var i in t||(t={}))x.call(t,i)&&w(e,i,t[i]);if(L)for(var i of L(t))P.call(t,i)&&w(e,i,t[i]);return e};var s=(e,t,i)=>(w(e,typeof t!="symbol"?t+"":t,i),i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function i(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerpolicy&&(o.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?o.credentials="include":r.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=i(r);fetch(r.href,o)}})();const D=`<h1>DEMO PIXELS</h1>
<div>
  <div class="card">
    <button id="launch" type="button">New</button>
    <button id="load" type="button" class="disabled">Load</button>
    <button id="options" type="button" class="disabled">Options</button>
    <button id="credits" type="button" class="disabled">Credits</button>
  </div>
</div>
<div id="display-test">&nbsp;</div>
<div id="game-container">
  <canvas id="canvas" width="640" height="360"></canvas>
</div>
<div id="footer">@art.malinaj 2022</div>
`;function A(e,t){const i=()=>{t.send("launch")};e.addEventListener("click",()=>i())}function O(e,t){const i=()=>{t.send("credits")};e.addEventListener("click",()=>i())}function N(e,t){const i=()=>{t.send("options")};e.addEventListener("click",()=>i())}class _{constructor(){s(this,"heldDirections",[]);s(this,"map",{ArrowUp:"up",KeyW:"up",ArrowDown:"down",KeyS:"down",ArrowLeft:"left",KeyA:"left",ArrowRight:"right",KeyD:"right"})}get direction(){return this.heldDirections[0]}init(){document.addEventListener("keydown",t=>{const i=this.map[t.code];i&&!this.heldDirections.includes(i)&&this.heldDirections.unshift(i)}),document.addEventListener("keyup",t=>{const i=this.map[t.code],n=this.heldDirections.indexOf(i);n>-1&&this.heldDirections.splice(n,1)})}}class F{constructor(t,i){s(this,"point");s(this,"cellSize");this.canvasElement=t,this.cellSize=i.cellSize||32}init(){this.canvasElement.addEventListener("mouseup",t=>{const i=Math.floor(t.offsetX/this.cellSize),n=Math.floor(t.offsetY/this.cellSize);this.point=[i,n]}),this.canvasElement.addEventListener("mousemove",t=>{const i=Math.floor(t.offsetX/this.cellSize),n=Math.floor(t.offsetY/this.cellSize);this.point=[i,n]})}}const a=32,R=640,U=360,h=e=>e*a,l=e=>Math.round(e/a),T=""+new URL("overworld.a3527e5a.jpg",import.meta.url).href,B=[{name:"water",area:[[0,5],[1,4],[2,3],[3,3],[4,4],[4,2],[4,1],[5,2],[5,1],[6,1],[6,0],[7,0],[5,4],[6,5],[6,4],[6,3],[7,4],[7,5],[7,6],[6,6],[8,6],[6,9],[6,10],[6,11],[7,9],[8,9],[8,10],[9,10],[15,10],[16,10],[17,10],[18,10],[19,10]]}];class W{constructor(t){s(this,"breakpoints",B)}init(t,i){const n=i[0]-h(9),r=i[1]-h(5);this.breakpoints.forEach(({area:o})=>{o.forEach(([c,u])=>{t.strokeStyle="rgba(255,0,0, 0.4)",t.lineWidth=2,t.strokeRect(c*a-n,u*a-r,a,a)})})}checkCollision(t,i){return this.breakpoints.findIndex(({area:n})=>n.findIndex(([r,o])=>r===t&&i===o)>-1)>-1}update(){}draw(t,i){this.init(t,i)}}class j{constructor(){s(this,"cursorPoint")}initGrid(t,i){const n=i[0]-h(9),r=i[1]-h(5);for(let o=0;o<40;o++)for(let c=0;c<30;c++)t.strokeStyle="rgba(255,255,255, 0.1)",t.lineWidth=2,t.strokeRect(o*a-n,c*a-r,a,a)}update(t){this.cursorPoint=t.point}drawCursor(t){if(!this.cursorPoint)return;const[i,n]=this.cursorPoint;t.strokeStyle="yellow",t.lineWidth=2,t.strokeRect(i*a+2,n*a+2,a-4,a-4)}draw(t,i){this.initGrid(t,i),this.drawCursor(t)}}class G{constructor(){s(this,"grid");s(this,"breakpointsMap");this.grid=new j,this.breakpointsMap=new W({})}update(t){this.grid.update(t)}checkCollision(t,i){return this.breakpointsMap.checkCollision(t,i)}draw(t,i){const n=new Image;n.onload=()=>{const r=h(9)-i[0],o=h(5)-i[1];t.fillStyle="black",t.fillRect(0,0,R,U),t.drawImage(n,r,o),t.fillStyle="white",t.fillText(`${r}:${o}`,550,80),t.fillText(`${l(r)}:${l(o)}`,550,100),t.stroke()},n.src=T,this.grid.draw(t,i),this.breakpointsMap.draw(t,i)}}const H=""+new URL("skeleton.4d01cb2f.png",import.meta.url).href;var d=(e=>(e.None="none",e.IdleDown="idleDown",e.IdleUp="idleUp",e.IdleLeft="idleLeft",e.IdleRight="idleRight",e.WalkDown="walkDown",e.WalkUp="walkUp",e.WalkLeft="walkLeft",e.WalkRight="walkRight",e))(d||{});const $={[d.IdleDown]:[[0,2]],[d.IdleUp]:[[0,0]],[d.IdleLeft]:[[0,1]],[d.IdleRight]:[[0,3]],[d.WalkRight]:[[0,3],[1,3],[2,3],[3,3],[4,3],[5,3],[6,3],[7,3],[8,3]],[d.WalkLeft]:[[0,1],[1,1],[2,1],[3,1],[4,1],[5,1],[6,1],[7,1],[8,1]],[d.WalkDown]:[[1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2],[8,2]],[d.WalkUp]:[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0]]};class q{constructor(t){s(this,"image");s(this,"animations");s(this,"currentAnimation");s(this,"currentAnimationFrame");s(this,"gameObject");s(this,"isLoaded",!1);s(this,"sx");s(this,"sy");s(this,"width");s(this,"height");s(this,"dx");s(this,"dy");s(this,"animationFrameLimit");s(this,"animationFrameProgrss");this.gameObject=t.gameObject,this.width=t.width||a,this.height=t.height||a,this.sx=t.sx||a,this.sy=t.sy||a,this.dx=t.dx||0,this.dy=t.dy||0,this.image=new Image,this.image.onload=()=>{this.isLoaded=!0},this.image.src=t.src,this.animations=t.animations?g({[d.None]:[[0,0]]},t.animations):{[d.None]:[[0,0]]},this.currentAnimation=t.currentAnimation||d.None,this.currentAnimationFrame=0,this.animationFrameLimit=t.animationFrameLimit||0,this.animationFrameProgrss=this.animationFrameLimit}get frame(){return this.animations[this.currentAnimation][this.currentAnimationFrame]}setAnimation(t){t!==this.currentAnimation&&(this.currentAnimation=t,this.currentAnimationFrame=0,this.animationFrameProgrss=this.animationFrameLimit)}updateAnimationProgress(){if(this.animationFrameProgrss>0){this.animationFrameProgrss-=1;return}this.animationFrameProgrss=this.animationFrameLimit,this.currentAnimationFrame+=1,this.frame||(this.currentAnimationFrame=0)}draw(t,i){if(this.isLoaded){const n=i[0]-h(9),r=i[1]-h(5),o=this.frame||[0,0],c=this.gameObject.x-this.dx-n,u=this.gameObject.y-this.dy-r;t.drawImage(this.image,this.sx*o[0],this.sy*o[1],this.sx,this.sy,c,u,this.width,this.height),this.updateAnimationProgress()}}}class b{constructor(t){s(this,"x");s(this,"y");s(this,"collision");s(this,"sprite");s(this,"isManagedByUser");[this.x,this.y]=[t.x||1,t.y||1];const i=t.spriteCfg||{};this.collision=t.collision,this.isManagedByUser=t.isManagedByUser,this.sprite=new q(g({gameObject:this,src:t.src,sx:32,sy:32},i))}update(t){}drawCollision(t,i){if(this.collision){t.strokeStyle="grey";const n=i[0]-h(9),r=i[1]-h(5),o=l(this.x),c=l(this.y);this.collision.forEach(([u,m])=>{t.strokeRect((o+u)*a-n,(c+m)*a-r,a,a)})}}draw(t,i){this.sprite.draw(t,i),this.drawCollision(t,i)}}const p=class extends b{constructor(i){super(i);s(this,"movingProcessLeftBehind",p.MOVING_PROCESS_LEFT_BEHIND_LIMIT);s(this,"directionUpdates",{up:["y",-1],down:["y",1],left:["x",-1],right:["x",1]});s(this,"direction","up")}updateAnimation(i){if(this.movingProcessLeftBehind>0&&this.direction){this.sprite.setAnimation(p.MAP_DIRECTION_ANIMATIONS[this.direction]);return}this.movingProcessLeftBehind===0&&!i.move&&this.sprite.setAnimation(p.MAP_IDLE_ANIMATIONS[this.direction])}updatePosition(i){if(this.movingProcessLeftBehind>0&&this.direction){const[n,r]=this.directionUpdates[this.direction],o={x:this.x,y:this.y};o[n]+=r*p.MOVING_PROCESS_LEFT_BEHIND_LIMIT;const c=l(o.x),u=l(o.y);i.checkCollision(c,u)||(this[n]+=r),this.movingProcessLeftBehind-=1}}update(i){this.updateAnimation(i),this.updatePosition(i),this.movingProcessLeftBehind===0&&i.move&&(this.movingProcessLeftBehind=p.MOVING_PROCESS_LEFT_BEHIND_LIMIT,this.direction=i.move)}drawCellUnderFeet(i,n){const r=l(this.x-n[0]),o=l(this.y-n[1]);i.fillStyle="rgba(255,0,0, 0.4)",i.lineWidth=2,i.fillRect(r*a+2,o*a+2,a-2,a-2)}drawHudCoords(i){const n=l(this.x),r=l(this.y);i.font="18px Inter, Avenir",i.fillStyle="lime",i.fillText(`${n}, ${r}`,h(0)+2,h(1)+9)}draw(i,n){this.drawCellUnderFeet(i,n),this.drawCollision(i,n),this.sprite.draw(i,n),this.isManagedByUser&&this.drawHudCoords(i)}};let f=p;s(f,"MOVING_PROCESS_LEFT_BEHIND_LIMIT",16),s(f,"MAP_DIRECTION_ANIMATIONS",{right:d.WalkRight,left:d.WalkLeft,down:d.WalkDown,up:d.WalkUp}),s(f,"MAP_IDLE_ANIMATIONS",{right:d.IdleRight,left:d.IdleLeft,down:d.IdleDown,up:d.IdleUp});function v({x:e,y:t,isManagedByUser:i}){return new f({x:e,y:t,src:H,isManagedByUser:i,collision:[[0,0]],spriteCfg:{width:2*a,height:2*a,sx:64,sy:64,dx:-1,dy:26,animationFrameLimit:6,animations:$,currentAnimation:d.IdleDown}})}const z=""+new URL("gravestone1.b4e1e37a.png",import.meta.url).href;class V extends b{constructor(i){super(i);s(this,"image");s(this,"isLoaded",!1);this.image=new Image,this.image.onload=()=>{this.isLoaded=!0},this.image.src=i.src}draw(i,n){this.drawCollision(i,n),this.sprite.draw(i,n)}}function K({x:e,y:t}){return new V({x:e,y:t,src:z,collision:[[0,0],[1,0]],spriteCfg:{width:2*a,height:2*a,sx:600,sy:600,dx:0,dy:28}})}class X{constructor(t){s(this,"canvas");s(this,"container");s(this,"renderCtx");s(this,"width");s(this,"height");s(this,"overworld");s(this,"objects");s(this,"assetObjects");s(this,"directionInput");s(this,"mousePointInput");s(this,"cameraPosition");this.container=t.element,this.canvas=this.container.querySelector("canvas"),this.width=640,this.height=360,this.renderCtx=this.canvas.getContext("2d"),this.directionInput=new t.DirectionInput,this.mousePointInput=new t.MouseInput(this.canvas,{cellSize:a}),this.overworld=new G;const i=v({x:h(3),y:h(8),isManagedByUser:!0});this.cameraPosition=[i.x,i.y],this.objects=[i,v({x:h(12),y:h(3)}),K({x:h(10),y:h(9)})],this.assetObjects=[]}drawStones(){this.assetObjects.forEach(t=>t.draw(this.renderCtx,this.cameraPosition))}drawCharacters(){this.objects.sort((t,i)=>t.y===i.y?t.isManagedByUser?1:-1:t.y>i.y?1:-1).forEach(t=>{t.isManagedByUser&&(t.update({move:this.directionInput.direction,point:this.mousePointInput.point,checkCollision:(i,n)=>t.collision?!!t.collision.find(([r,o])=>this.objects.find(m=>{const k=l(m.x),S=l(m.y);return!m.isManagedByUser&&m.collision&&m.collision.find(([C,M])=>i+r===k+C&&n+o===S+M)})?!0:this.overworld.checkCollision(i+r,n+o)):!1}),this.cameraPosition=[t.x,t.y]),t.draw(this.renderCtx,this.cameraPosition)})}drawHud(){if(this.mousePointInput.point){this.renderCtx.font="18px Inter, Avenir",this.renderCtx.fillStyle="yellow";const t=this.mousePointInput.point[0]+l(this.cameraPosition[0])-9,i=this.mousePointInput.point[1]+l(this.cameraPosition[1])-5;this.renderCtx.fillText(`${t}, ${i}`,h(0)+2,h(0)+18)}}run(){this.draw(),requestAnimationFrame(()=>{this.run()})}init(){this.directionInput.init(),this.mousePointInput.init(),this.run()}draw(){this.overworld.update({point:this.mousePointInput.point}),this.overworld.draw(this.renderCtx,this.cameraPosition),this.drawHud(),this.drawStones(),this.drawCharacters()}}function Y(e,t){const i=()=>{new X({element:e,DirectionInput:_,MouseInput:F}).init()};t.track(n=>{},"canvas"),i()}const I=Symbol("MSG"),y={[I]:[],get messages(){return this[I]},_subscribers:new Map,track(e,t){this._subscribers.set(t,e)},send(e){this[I].unshift(e),this._subscribers.forEach(t=>t(e))},unsubscribe(e){this._subscribers.delete(e)}};document.querySelector("#app").innerHTML=`
 ${D}
`;A(document.querySelector("#launch"),y);O(document.querySelector("#credits"),y);N(document.querySelector("#options"),y);Y(document.querySelector("#game-container"),y);
